<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Academia</title>
    <style>
        body { font-family: sans-serif; background: #121212; color: #eee; padding: 20px; }
        .container { max-width: 600px; margin: auto; }
        .card { background: #1e1e1e; padding: 20px; border-radius: 8px; border: 1px solid #333; margin-bottom: 20px; }
        input { width: 100%; padding: 10px; margin: 8px 0; background: #2c2c2c; border: 1px solid #444; color: #fff; border-radius: 4px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; background: #1e1e1e; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #333; }
        th { color: #007bff; }
        .loading { text-align: center; color: #888; padding: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Sistema de Matrículas</h2>

    <div class="card">
        <h3>Nova Matrícula</h3>
        <input type="text" id="nome" placeholder="Nome do Aluno">
        <input type="text" id="cpf" placeholder="CPF">
        <input type="number" id="valor" placeholder="Valor da Mensalidade">
        <button onclick="cadastrar()">SALVAR MATRÍCULA</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>Aluno</th>
                <th>Tempo</th>
                <th>Valor</th>
            </tr>
        </thead>
        <tbody id="corpo-tabela">
            <tr><td colspan="3" class="loading">Buscando dados no Termux...</td></tr>
        </tbody>
    </table>
</div>

<script>
    // URL DO SEU NGROK (Sempre verifique se o ID mudou)
    const API_URL = 'https://2e7415640551.ngrok-free.app/api.php';
    
    // Headers necessários para o seu PHP e para o bypass do ngrok
    const myHeaders = {
        'ngrok-skip-browser-warning': 'true'
    };

    // 1. FUNÇÃO PARA LISTAR (GET)
    async function listar() {
        try {
            const r = await fetch(`${API_URL}?action=listar_alunos`, {
                method: 'GET',
                headers: myHeaders
            });
            const res = await r.json();
            
            if(res.status === 'success') {
                const html = res.data.map(aluno => `
                    <tr>
                        <td>${aluno.nome}<br><small>${aluno.cpf}</small></td>
                        <td>${aluno.meses_na_academia} meses</td>
                        <td style="color: #28a745">R$ ${aluno.mensalidade}</td>
                    </tr>
                `).join('');
                document.getElementById('corpo-tabela').innerHTML = html || '<tr><td colspan="3">Nenhum aluno.</td></tr>';
            }
        } catch (e) {
            document.getElementById('corpo-tabela').innerHTML = '<tr><td colspan="3" style="color:red">Erro de conexão. Verifique o Ngrok.</td></tr>';
        }
    }

    // 2. FUNÇÃO PARA CADASTRAR (POST)
    async function cadastrar() {
        const nome = document.getElementById('nome').value;
        const cpf = document.getElementById('cpf').value;
        const valor = document.getElementById('valor').value;

        if(!nome || !cpf || !valor) return alert("Preencha tudo!");

        // Criando o FormData que o seu PHP espera receber
        const bodyData = new FormData();
        bodyData.append('nome', nome);
        bodyData.append('cpf', cpf);
        bodyData.append('valor', valor);

        try {
            const r = await fetch(`${API_URL}?action=cadastrar_aluno`, {
                method: 'POST',
                body: bodyData,
                headers: myHeaders // Importante para o Ngrok não bloquear
            });
            const res = await r.json();

            if(res.status === 'success') {
                alert("Matrícula realizada!");
                // Limpa campos
                document.getElementById('nome').value = '';
                document.getElementById('cpf').value = '';
                document.getElementById('valor').value = '';
                listar(); // Atualiza a lista
            } else {
                alert("Erro ao salvar no banco.");
            }
        } catch (e) {
            alert("Erro de conexão com o Termux.");
        }
    }

    // Iniciar listagem
    window.onload = listar;
</script>

</body>
</html>
